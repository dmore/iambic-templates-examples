template_type: NOQ::AWS::IAM::Role
identifier: IambicSpokeRole
properties:
  description: This role is used by IAMbic to perform all actions on the account. It is assumed by the Iambic hub role in the hub account. Managed via CloudFormation.
  assume_role_policy_document:
    statement:
      - action:
          - sts:AssumeRole
          - sts:TagSession
        effect: Allow
        principal:
          aws: arn:aws:iam::580605962305:role/IambicHubRole
    version: '2012-10-17'
  inline_policies:
    - policy_name: base_permissions
      statement:
        - action:
            - ec2:Describe*
            - iam:*
            - identitystore:*
            - organizations:describe*
            - organizations:list*
            - sso:*
          effect: Allow
          resource:
            - '*'
        - action:
            - secretsmanager:CreateSecret
            - secretsmanager:GetSecretValue
            - secretsmanager:PutSecretValue
            - secretsmanager:describesecret
            - secretsmanager:listsecrets
            - secretsmanager:listsecretversionids
          effect: Allow
          resource:
            - arn:aws:secretsmanager:*:*:secret:iambic-config-secrets-*
        - action:
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
            - sqs:GetQueueUrl
            - sqs:ReceiveMessage
            - sqs:SendMessage
          effect: Allow
          resource:
            - arn:aws:sqs:*:*:IAMbicChangeDetectionQueue
          sid: SqsWriteAccessForResourceMonitoring
      version: '2012-10-17'
    - included_accounts:
        - iambic_test_spoke_account_1
      policy_name: delete_sqs_message
      statement:
        - action: sqs:DeleteMessage
          effect: Allow
          resource: arn:aws:sqs:us-east-1:{{var.account_id}}:iambic-itest-iam-mutation-events
          sid: VisualEditor0
      version: '2012-10-17'
    - included_accounts:
        - iambic_test_spoke_account_1
      policy_name: iambic_secrets
      statement:
        - action:
            - secretsmanager:GetSecretValue
            - secretsmanager:describesecret
            - secretsmanager:getrandompassword
            - secretsmanager:getresourcepolicy
            - secretsmanager:listsecrets
            - secretsmanager:listsecretversionids
          effect: Allow
          resource:
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/github-token-iambic-templates-itest
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/github-token-iambic-templates-itest-*
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/google
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/google-*
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/iambic-full
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/iambic-full-*
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:dev/iambic_itest_secret*
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:test/google-only-secret
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:test/google-only-secret-*
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:test/okta-only-secret
            - arn:aws:secretsmanager:us-west-2:{{var.account_id}}:secret:test/okta-only-secret-*
      version: '2012-10-17'
  managed_policies:
    - policy_arn: arn:aws:iam::aws:policy/ReadOnlyAccess
  role_name: IambicSpokeRole
